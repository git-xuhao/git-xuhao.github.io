{"title":"Android 切换系统语言功能实现（下）","slug":"android-change-language_02","date":"2016-04-12T04:05:24.000Z","updated":"2017-12-17T15:32:36.000Z","comments":true,"path":"api/articles/android-change-language_02.json","photos":[],"link":"","excerpt":"概述：简单介绍下这个需求的缘由，这段时间因公司业务需要，其中有一项“设置系统语言”功能，就是在使用APP的过程中，动态的去切换整个Android机器的语言，具体参照手机设置页面有语言切换功能。期初想来是很简单的事情嘛，不就是个简单的资源国际化嘛，strings.xml资源文件一整还不给OK？真正动起手来就真不是这么一回事了，国际化是没问题，但是怎样能更改所有页面的文字资源呢，这是一个问题。下面介绍下网上找的几个方案。一、API欺骗   烧制到手机中的android.jar包含了Android所需的各种类与方法；而供开发者使用的android.jar只是其中的一部分。API欺骗是指在应用中去模拟未公开的类和方法让应用编译通过并生成APK，然而在应用实际运行中调用的却仍是烧制到手机中真实的android.jar。<br>","covers":null,"content":"<h2 id=\"概述：\"><a href=\"#概述：\" class=\"headerlink\" title=\"概述：\"></a><strong>概述：</strong></h2><p>简单介绍下这个需求的缘由，这段时间因公司业务需要，其中有一项“设置系统语言”功能，就是在使用APP的过程中，动态的去切换整个Android机器的语言，具体参照手机设置页面有语言切换功能。期初想来是很简单的事情嘛，不就是个简单的资源国际化嘛，strings.xml资源文件一整还不给OK？真正动起手来就真不是这么一回事了，国际化是没问题，但是怎样能更改所有页面的文字资源呢，这是一个问题。下面介绍下网上找的几个方案。</p>\n<h4 id=\"一、API欺骗\"><a href=\"#一、API欺骗\" class=\"headerlink\" title=\"一、API欺骗\"></a>一、API欺骗</h4><p>   烧制到手机中的android.jar包含了Android所需的各种类与方法；而供开发者使用的android.jar只是其中的一部分。API欺骗是指在应用中去模拟未公开的类和方法让应用编译通过并生成APK，然而在应用实际运行中调用的却仍是烧制到手机中真实的android.jar。<br> <a id=\"more\"></a></p>\n<h4 id=\"二、使用Java反射机制\"><a href=\"#二、使用Java反射机制\" class=\"headerlink\" title=\"二、使用Java反射机制\"></a>二、使用Java反射机制</h4><pre><code>IActivityManager与ActivityManagerNative都是非公开类，使用Java反射去调用其中的方法。\n</code></pre><p>但是这个弊端是显而易见的，上述两种方法都是去更改系统的语言的类型，功能和你去设置页面去设置语言类型的效果一样。发现对当前系统设置了新的Locale后，不单自己的应用语系改变了，系统所有的应用语系都改变了，这正是我们所需要的。折腾了下下这个很2的问题。<strong>网上放的方法比较旧， Android5.1的话， 设置后当时生效， 重启后就失效了。</strong></p>\n<h4 id=\"核心代码如下：\"><a href=\"#核心代码如下：\" class=\"headerlink\" title=\"核心代码如下：\"></a><strong>核心代码如下：</strong></h4><figure class=\"highlight cos\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * TODO&lt;更新系统语言&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> * </span></span><br><span class=\"line\"><span class=\"comment\"> * @author Xiho</span></span><br><span class=\"line\"><span class=\"comment\"> * @versionCode 1 &lt;每次修改提交前+1&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\">@SuppressWarnings(<span class=\"string\">\"unchecked\"</span>)</span><br><span class=\"line\">public <span class=\"keyword\">class</span> LanguageUtils &#123;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tpublic static void updateLanguage(Locale locale) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t\tObject objIActMag, objActMagNative<span class=\"comment\">;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">Class</span> clzIActMag = <span class=\"keyword\">Class</span>.forName(<span class=\"string\">\"android.app.IActivityManager\"</span>)<span class=\"comment\">;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">Class</span> clzActMagNative = <span class=\"keyword\">Class</span></span><br><span class=\"line\">\t\t\t\t\t.forName(<span class=\"string\">\"android.app.ActivityManagerNative\"</span>)<span class=\"comment\">;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"comment\">//amn = ActivityManagerNative.getDefault(); </span></span><br><span class=\"line\">\t\t\tMethod mtdActMagNative<span class=\"built_in\">$getDefault</span> = clzActMagNative</span><br><span class=\"line\">\t\t\t\t\t.getDeclaredMethod(<span class=\"string\">\"getDefault\"</span>)<span class=\"comment\">;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tobjIActMag = mtdActMagNative<span class=\"built_in\">$getDefault</span>.invoke(clzActMagNative)<span class=\"comment\">;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t <span class=\"comment\">// objIActMag = amn.getConfiguration();  </span></span><br><span class=\"line\">\t\t\tMethod mtdIActMag<span class=\"built_in\">$getConfiguration</span> = clzIActMag</span><br><span class=\"line\">\t\t\t\t\t.getDeclaredMethod(<span class=\"string\">\"getConfiguration\"</span>)<span class=\"comment\">;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tConfiguration config = (Configuration) mtdIActMag<span class=\"built_in\">$getConfiguration</span></span><br><span class=\"line\">\t\t\t\t\t.invoke(objIActMag)<span class=\"comment\">;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// set the locale to the new value  </span></span><br><span class=\"line\">\t\t\tconfig.locale = locale<span class=\"comment\">;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"comment\">//持久化   config.userSetLocale = true; </span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">Class</span> clzConfig = <span class=\"keyword\">Class</span></span><br><span class=\"line\">\t\t\t\t\t.forName(<span class=\"string\">\"android.content.res.Configuration\"</span>)<span class=\"comment\">;</span></span><br><span class=\"line\">\t\t\tjava.lang.reflect.Field userSetLocale = clzConfig</span><br><span class=\"line\">\t\t\t\t\t.getField(<span class=\"string\">\"userSetLocale\"</span>)<span class=\"comment\">;</span></span><br><span class=\"line\">\t\t\tuserSetLocale.<span class=\"keyword\">set</span>(config, true)<span class=\"comment\">;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// 此处需要声明权限:android.permission.CHANGE_CONFIGURATION</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// 会重新调用 onCreate();</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">Class</span>[] clzParams = &#123; Configuration.<span class=\"keyword\">class</span> &#125;<span class=\"comment\">;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// objIActMag.updateConfiguration(config);</span></span><br><span class=\"line\">\t\t\tMethod mtdIActMag<span class=\"built_in\">$updateConfiguration</span> = clzIActMag</span><br><span class=\"line\">\t\t\t\t\t.getDeclaredMethod(<span class=\"string\">\"updateConfiguration\"</span>, clzParams)<span class=\"comment\">;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tmtdIActMag<span class=\"built_in\">$updateConfiguration</span>.invoke(objIActMag, config)<span class=\"comment\">;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tBackupManager.dataChanged(<span class=\"string\">\"com.android.providers.settings\"</span>)<span class=\"comment\">;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">\t\t\te.printStackTrace()<span class=\"comment\">;</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这样我们利用JAVA的反射机制，调用那些隐藏的方法就可以实现了。</p>\n<ul>\n<li><strong>需要注意的是</strong>调用此方法：</li>\n</ul>\n<figure class=\"highlight arduino\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// objIActMag.updateConfiguration(config);</span></span><br><span class=\"line\">mtdIActMag$updateConfiguration.invoke(objIActMag, <span class=\"built_in\">config</span>);</span><br></pre></td></tr></table></figure>\n<p>需要加上权限：</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">android<span class=\"selector-class\">.permission</span><span class=\"selector-class\">.CHANGE_CONFIGURATION</span></span><br></pre></td></tr></table></figure>\n<p>并且此处会重新调用onCreate方法，我就在这个地方处被坑了一把。（如果调用此方法的时候做了一些逻辑，就注意下）。</p>\n<p>不同的地方在添加了</p>\n<figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Class <span class=\"keyword\">clzConfig </span>= Class.forName(<span class=\"string\">\"android.content.res.Configuration\"</span>)<span class=\"comment\">; </span></span><br><span class=\"line\"><span class=\"keyword\">java.lang.reflect.Field </span>userSetLocale = <span class=\"keyword\">clzConfig.getField(\"userSetLocale\"); </span></span><br><span class=\"line\">userSetLocale<span class=\"meta\">.set</span>(<span class=\"built_in\">config</span>, true)<span class=\"comment\">;</span></span><br></pre></td></tr></table></figure>\n<p>Debug发现的逻辑是：<br>1： 持久化保存下来</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">SystemProperties</span><span class=\"selector-class\">.set</span>(\"<span class=\"selector-tag\">persist</span><span class=\"selector-class\">.sys</span><span class=\"selector-class\">.language</span>\", <span class=\"selector-tag\">l</span><span class=\"selector-class\">.getLanguage</span>());</span><br><span class=\"line\"><span class=\"selector-tag\">SystemProperties</span><span class=\"selector-class\">.set</span>(\"<span class=\"selector-tag\">persist</span><span class=\"selector-class\">.sys</span><span class=\"selector-class\">.country</span>\", <span class=\"selector-tag\">l</span><span class=\"selector-class\">.getCountry</span>());</span><br></pre></td></tr></table></figure>\n<p>2： 开机AndroidRuntime读取这个属性， 更新系统之前的属性。估计是为了方便跑测试的Case添加的这个逻辑。</p>\n<p><strong> 最后声明：</strong></p>\n<p>既然是更改系统的配置当然你的签名也应该是系统签名和sharedUserId。不然会类似以下的错误！</p>\n<p>error：</p>\n<font color=\"#ff0000\" size=\"5\" face=\"黑体\">java.lang.SecurityException: Permission Denial: updateConfiguration() from pid=31594, uid=10099 requires android.permission.CHANGE_CONFIGURATION</font>\n\n\n<p>各位都注意下吧~</p>\n<p>附上GitHub源码：<a href=\"https://github.com/git-xuhao/SwitchLanguage\" target=\"_blank\" rel=\"noopener\">SwitchLanguage</a>；</p>\n<h3 id=\"welcome-everyone’s-Star-and-fork！\"><a href=\"#welcome-everyone’s-Star-and-fork！\" class=\"headerlink\" title=\"welcome everyone’s Star and fork！\"></a><strong>welcome everyone’s Star and fork！</strong></h3><blockquote>\n<p>转载请标明出处： <a href=\"http://blog.csdn.net/u011974987/article/details/50801770\" target=\"_blank\" rel=\"noopener\">http://blog.csdn.net/u011974987/article/details/50801770</a></p>\n</blockquote>\n","categories":[{"name":"Android","slug":"Android","count":11,"path":"api/categories/Android.json"}],"tags":[{"name":"Android","slug":"Android","count":11,"path":"api/tags/Android.json"}]}