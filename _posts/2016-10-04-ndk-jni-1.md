---
layout: post
title: Android NDK开发JNI简介及调用流程（一）
permalink: ndk-jni-1
date: 2016-10-04 15:28:31
categories: NDK
tags: ndk
desc: 前段时间学习了C、C++的一些基础知识后，了解了它们的编码风格，要想掌握NDK开发，前提是会使用JNI，下面我们开始简单的介绍吧！
---

### **前言**
前段时间学习了C、C++的一些基础知识后，了解了它们的编码风格，要想掌握NDK开发，前提是会使用JNI，下面我们开始简单的介绍吧！

### **JNI简介**

　　JNI全称是Java Native Interface（Java本地接口），本地接口就是指用C和C++开发的接口。从Java1.1开始，JNI标准成为java平台的一部分，它允许Java代码和其他语言写的代码进行交互。JNI一开始是为了本地已编译语言，尤其是C和C++而设计的，但是它并不妨碍你使用其他编程语言，只要调用约定受支持就可以了。 

　　开发JNI程序会受到系统环境的限制，因为用C/C++语言写出来的代码或模块，编译过程当中要依赖当前操作系统环境所提供的一些库函数，并和本地库链接在一起。而且编译后生成的二进制代码只能在本地操作系统环境下运行，因为不同的操作系统环境，有自己的本地库和CPU指令集，而且各个平台对标准C/C++的规范和标准库函数实现方式也有所区别。这就造成使用了JNI接口的JAVA程序，不再像以前那样自由的跨平台。如果要实现跨平台，就必须将本地代码在不同的操作系统平台下编译出相应的动态库。

<!-- more -->
**JNI的开发流程主要分为以下几个步骤：**

1. 编写带有native声明方法的java类；

2. 用"javac"命令来编译所编写的java类；

3. 使用"javah"java类的名生成扩展名为h的头文件；

4. 复制jni.h和jni_md.h文件到CPP工程中;

5. 实现.h头文件中声明的函数

6. 生成dll动态链接库

7. 配置dll文件所在目录到环境变量

8. 重启Eclipse

**jni调用dill的流程图如下：**

![这里写图片描述](https://img-blog.csdn.net/20160921002729113)

通过上面的分析，相信大家已经对jni的开发流程有一个整体的认识，接下来，我们将通过实例更进一步的了解。


#### **第一步：编写带有native声明方法的java类**

JniTest.java

```
package com.study.jni;

public class JniTest {
	
	public native static String getStringFromC();
}
```
#### **第二步：用"javac"命令来编译所编写的java类；**

首先我们必须得配有java环境变量，然后我们右键点击项目->properties,复制项目路径；

![这里写图片描述](https://img-blog.csdn.net/20160921004851299)

然后进入dos命令，

```
C:\Users\uuxuh>cd E:\Documents\11\JniTest

C:\Users\uuxuh>E:

E:\Documents\11\JniTest>cd src

E:\Documents\11\JniTest\src>
```

#### **第三步：使用"javah"java类的名生成.h的头文件**
接着，复制我们的完整类名（包名+类名），执行命令：

```
E:\Documents\11\JniTest\src>javah com.study.jni.JniTest
```
回到工程目录下，刷新项目，编译后的.h头文件就出现了。

源码：

com_study_jni_JniTest.h

```
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class com_study_jni_JniTest */

#ifndef _Included_com_study_jni_JniTest
#define _Included_com_study_jni_JniTest
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     com_study_jni_JniTest
 * Method:    getStringFromC
 * Signature: ()Ljava/lang/String;
 */
JNIEXPORT jstring JNICALL Java_com_study_jni_JniTest_getStringFromC
  (JNIEnv *, jclass);

#ifdef __cplusplus
}
#endif
#endif

```

#### **第四步：复制jni.h和jni_md.h文件到CPP工程中**
将要编译的文件中引入了

```
#inlcude<jni.h>
```
头文件，所以我们手动导入这两个文件到CPP工程中，

以我的jdk1.7.0_75为例，两个头文件的位置分别为：
```
jni.h    jdk1.7.0_75/include
jni_md.h    jdk1.7.0_75/include/linux
```
将我们生成.h头文件复制到项目的代码文件目录下 ， 在解决方案中的头文件目录-> 右键-> 添加 -> 添加现有项 。 将我们的头文件添加进来，还有jni.h和jni_md.h一起添加进来，如图：

![这里写图片描述](https://img-blog.csdn.net/20160921011013003)

#### **第五步：实现.h头文件中声明的函数**


c代码如下：

```
#include "com_study_jni_JniTest.h"

//函数实现
JNIEXPORT jstring JNICALL Java_com_study_jni_JniTest_getStringFromC
(JNIEnv *env, jclass jcls){
	//简单的实现
return (*env)->NewStringUTF(env, "C String");


}

```
#### **第六步：生成dll动态链接库**

我们以VS2013为例：

操作步骤：

选中项目 -> 右键 -> 属性 -> 常规 -> 项目默认值 -> 配置类型 , 选择动态库.dll，

![这里写图片描述](https://img-blog.csdn.net/20160921011522662)

如图，右上角配置管理器，根据我们所使用的平台进去配置一下：

![这里写图片描述](https://img-blog.csdn.net/20160921011811821)

这里我使用64位的，所以活动解决方案平台下新建了一个x64，部署项目配置也选择x64。

配置完了之后，最后生成解决方案。去项目目录下查看dll动态库。

![这里写图片描述](https://img-blog.csdn.net/20160921012257530)

#### <font color=blue>**第七步：配置dll文件所在目录到环境变量**

我们把生成dll文件的路径配置java环境变量里面，这样java 才会知道有dll动态库存在，配置完之后，重启下Eclipse。

最后我们在java中调用动态库，完整代码：

```
package com.study.jni;

public class JniTest {
	
	public native static String getStringFromC();

	public static void main(String[] args) {
		System.out.println(getStringFromC());
	}
	
// 加载动态库
	static{
	   System.loadLibrary("jni_study");
	}

}

```

最后运行一下项目控制台打印出C中返回给我们的字符串。

![这里写图片描述](https://img-blog.csdn.net/20160921013119011)

好了，整个jni的调用流程已经说的非常详细了，但这只是jni入门的基础，后续会继续更新！


> 学习理解并整理下来的笔记；  
> 希望大家能够指点或提出宝贵意见，一起学习，谢谢！ 
> 转载请注明出处：[http://blog.csdn.net/u011974987/article/details/52602913](http://blog.csdn.net/u011974987/article/details/52602913)
> 个人主页：[xuhaoblog.com](http://xuhaoblog.com)




